<!DOCTYPE html>
<html>
<head>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
   <link rel="stylesheet" href="../static/css/stylesheet2.css">
</head>
<body>
<div class='topWrapper'>
    <div class='dateTitleBox'>
        <div class="center">
            Date
        </div>
    </div>
    <div class='dateBox'>
        <select id="date_select_tag">

        </select>
    </div>
    <div class='optionsTitleBox'>
        <div class="center">
            Sort By Average
        </div>
    </div>
    <div class='optionsBox'>
        <div class="center">
            <button class='optionButton' id="prefer_sound" text-align="center"></button>
            <button class='optionButton' id="prefer_temperature" text-align="center"></button>
            <button class='optionButton' id="prefer_co2" text-align="center"></button>
        </div>
    </div>
    <div class='preferenceTitleBox'>
        <div class="center">
            Preference Level
        </div>
    </div>
    <div class='preferenceBox'>
        <div class="center">
            <img src="../static/images/minNoise.png" alt="MinNoise" width="100" height="100">
            <button class='buttonLined' text-align="inline" id="prefer_low"></button>
            <button class='buttonLined' text-align="inline" id="prefer_normal"></button>
            <button class='buttonLined' text-align="inline" id="prefer_high"></button>
            <img src="../static/images/maxNoise.png" alt="MaxNoise" width="100" height="100">
        </div>
    </div>
</div>

<div class='middleWrapper'>
    <div class='tableCellsBox'>

        <table style="color: black" id="study_table_list">
            <tr>
                <td>

        </td>
        <td>
            9am-10am
        </td>
        <td>
            10am-11am
        </td>
        <td>
            11am-12pm
        </td>
        <td>
            12pm-1pm
        </td>
        <td>
            1pm-2pm
        </td>
        <td>
            2pm-3pm
        </td>
        <td>
            3pm-4pm
        </td>
        <td>
            4pm-5pm
        </td>
        <td>
            5pm-6pm
        </td>
        <td>
            6pm-7pm
        </td>
        <td>
            7pm-8pm
        </td>
        <td>
            8pm-9pm
        </td>
        </tr>

        </table>
    </div>
</div>

<div class='bottomWrapper'>
    <div class='legendBox'>
      <div class='legendRedCell'></div>
    </div>
    <div class='selectionsTitleBox'>Selected Bookings:</div>
    <div class='selectionsBox'>SELECTED BOOKINGS GO HERE</div>
    <div class='proceedBox'>
        <button class="proceedButton" text-align="center" type="submit"><b>Confirm</b></button>
    </div>
</div>

<script>
  var studyTables;
  var level = 0;
  var sortObjects = ["sound_level", "temperature_level", "co2_level"];
  var sortIndex = 0;
  const ranges = [
    {
      0: [0, 100],
      1: [101, 900],
      2: [901, 10000000]
    },
    {
      0: [0, 19],
      1: [20, 25],
      2: [26, 10000]
    },
    {
      0: [0, 400],
      1: [401, 1000],
      2: [1001, 100000000]
    }
  ]

  document.getElementById("prefer_sound").onclick = function() {
    sortIndex = 0;
    displayTable();
  }

  document.getElementById("prefer_temperature").onclick = function() {
    sortIndex = 1;
    displayTable();
  }

  document.getElementById("prefer_co2").onclick = function() {
    sortIndex = 2;
    displayTable();
  }

  document.getElementById("prefer_low").onclick = function() {
    level = 0;
    displayTable();
  }

  document.getElementById("prefer_normal").onclick = function() {
    level = 1;
    displayTable();
  }

  document.getElementById("prefer_high").onclick = function() {
    level = 2;
    displayTable();
  }

  // Display table based on the current preference settings
  function displayTable() {
    const studyTableList = document.getElementById("study_table_list")
    while (studyTableList.childNodes.length > 2) {
      studyTableList.removeChild(studyTableList.lastChild);
    }
    for (const [studyTableName, studyTableData] of Object.entries(studyTables)) {
      var measurement_level = studyTableData.table_stats[sortObjects[sortIndex]];
      if (measurement_level >= ranges[sortIndex][level][0] && measurement_level <= ranges[sortIndex][level][1]) {
        var tr = document.createElement("tr");
        start = 9;
        end = 20;
        var deskname_td = document.createElement("td");
        var deskname_h2 = document.createElement("h2");
        deskname_h2.className = "deskName";
        deskname_h2.innerHTML = studyTableName;
        deskname_td.appendChild(deskname_h2);
        tr.appendChild(deskname_td);
        for (var i = start; i <= end; i++) {
          var td = document.createElement("td");
          var availability_button = document.createElement("button");
          availability_button.className = "cell";
          availability_button.style.textAlign = "center";
          if (studyTableData.availability[i] === true) {
            availability_button.style.backgroundColor = "green";
          } else {
            availability_button.style.backgroundColor = "red";
          }
          td.appendChild(availability_button);
          tr.appendChild(td);
        }
        studyTableList.appendChild(tr);
      }
    }
  }

  async function loadTablesData(dateString) {
    const res = await axios.get('/booking/available_tables', {
        booking_date: dateString
    });
    studyTables = res.data;
    console.log(studyTables)
    displayTable();
  }

  function handleDateSelectChange() {
    var selectBox = document.getElementById("date_select_tag");
    var selectedValue = selectBox.options[selectBox.selectedIndex].value;
    console.log(selectedValue)
  }

  const today = new Date();
  const dateSelectTag = document.getElementById("date_select_tag");
  for (var i = 0; i < 14; i++) {
    var opt = document.createElement('option');
    if (i === 0) {
      opt.value = today.toISOString().split("T")[0];
      opt.innerHTML = today.toISOString().split("T")[0];
    } else {
      today.setDate(today.getDate() + 1);
      opt.value = today.toISOString().split("T")[0];
      opt.innerHTML = today.toISOString().split("T")[0];
    }
    opt.onclick = function() {
      console.log(today.toISOString());
      loadTablesData(today.toISOString().split("T")[0])
    }
    dateSelectTag.appendChild(opt);
  }
  loadTablesData(today.toISOString().split("T")[0])
  </script>
</body>
</html>
